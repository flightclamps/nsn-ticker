// 1. Expanded Top Performer Helper with Box Score data
async function getTopPerformerWithBoxScore(event) {
  // Safety checks
  if (!event || !event.id) return "";
  
  try {
    // Fetch detailed box score data for this specific game
    const boxScoreUrl = `https://site.api.espn.com/apis/site/v2/sports/${event.league}/scoreboard/${event.id}`;
    const boxScoreData = await fetchData(PROXY + encodeURIComponent(boxScoreUrl));
    
    if (!boxScoreData || !boxScoreData.competitions || boxScoreData.competitions.length === 0) {
      return getTopPerformer(event.competitions[0]); // Fallback to basic leader data
    }
    
    const comp = boxScoreData.competitions[0];
    
    // Get leaders from the box score data
    if (!comp.leaders || comp.leaders.length === 0) return "";
    
    // Find the most impressive stat category (usually index 0)
    const category = comp.leaders[0];
    
    if (!category.leaders || category.leaders.length === 0) return "";
    
    const player = category.leaders[0];
    const name = player.athlete?.shortName || player.athlete?.displayName || "Player";
    const stat = player.displayValue;
    const statLabel = category.shortDisplayName || category.displayName || "";
    
    // Return formatted HTML with more detailed stats if available
    return `<span class="stat-pop">⭐ ${name}: ${stat} ${statLabel}</span>`;
  } catch (error) {
    // Fallback to basic leader info if box score fetch fails
    return getTopPerformer(event.competitions[0]);
  }
}

// 3. Updated Score Builder to include box score data
async function getScores() {
  // Expanded Source List with sport type for box score URLs
  const sources = [
    { l: "NFL", u: "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard", league: "football/nfl" },
    { l: "CFB", u: "https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?limit=25&groups=80", league: "football/college-football" },
    { l: "NBA", u: "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard", league: "basketball/nba" },
    { l: "CBB", u: "https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard?limit=25&groups=50", league: "basketball/mens-college-basketball" },
    { l: "MLB", u: "https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard", league: "baseball/mlb" },
    { l: "NHL", u: "https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard", league: "hockey/nhl" }
  ];

  let items = [];
  for (const s of sources) {
    const data = await fetchData(PROXY + encodeURIComponent(s.u));
    const events = data.events || [];
    
    // Process events (limit to 5 games per sport)
    for (const ev of events.slice(0, 5)) {
      const c = ev.competitions[0];
      const s1 = c.competitors[0]; // Home
      const s2 = c.competitors[1]; // Away
      
      // Team Names (Use Ranks if available)
      let t1 = s1.team.abbreviation;
      let t2 = s2.team.abbreviation;
      if (s1.curatedRank?.current <= 25) t1 = `(#${s1.curatedRank.current}) ` + t1;
      if (s2.curatedRank?.current <= 25) t2 = `(#${s2.curatedRank.current}) ` + t2;

      const score1 = s1.score;
      const score2 = s2.score;
      
      const status = ev.status.type.state; // pre, in, post
      const detail = ev.status.type.shortDetail;

      let labelClass = "bg-betting"; // Default Green
      let labelText = s.l;
      let mainText = `${t2} vs ${t1}`;
      
      // Prepare event data for box score lookup
      ev.league = s.league;

      // Get detailed player stats - only for in-progress or completed games
      let leaderHTML = "";
      if (status === "in" || status === "post") {
        // For completed/in-progress games, get detailed box score stats
        leaderHTML = await getTopPerformerWithBoxScore(ev);
      } else {
        // For upcoming games, don't show stats
        leaderHTML = "";
      }

      if (status === "post") {
         labelClass = "bg-final";
         labelText = "FINAL";
         mainText = `${t2} ${score2} - ${t1} ${score1}`;
      } else if (status === "in") {
         labelClass = "bg-live";
         labelText = "LIVE";
         mainText = `${t2} ${score2} - ${t1} ${score1} <span style='color:#FF0033'>• ${detail}</span>`;
      } else {
         // Upcoming
         mainText = `${t2} @ ${t1} [${detail}]`;
      }

      items.push({
         html: `<div class="label ${labelClass}"><span>${labelText}</span></div> ${mainText} ${leaderHTML}`
      });
    }
  }
  return items;
}