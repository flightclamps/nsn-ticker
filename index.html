<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NSN Broadcast Ticker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  /* Base Styles */
  body {
    margin: 0;
    background: #000;
    overflow: hidden;
    font-family: 'Inter', Arial, sans-serif;
  }

  /* The main container for the ticker strip */
  .nsn-bar {
    width: 100vw;
    height: 52px; /* Slightly taller for better visibility */
    background: #090909; /* Deep Black */
    border-top: 3px solid #00E5FF; /* Electric Cyan Top Border */
    border-bottom: 3px solid #D500F9; /* Neon Purple Bottom Border */
    display: flex;
    align-items: center;
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.2); /* Glow effect */
  }

  /* Fixed Logo/Network Branding Section */
  .nsn-logo {
    width: 130px;
    min-width: 130px;
    height: 100%;
    background: linear-gradient(135deg, #1A237E, #000000); /* Deep Blue to Black */
    border-right: 2px solid #00E5FF;
    display: flex;
    flex-direction: column; /* Stack text vertically */
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    z-index: 10;
  }

  .nsn-title {
    font-size: 22px;
    font-weight: 900;
    color: #FFFFFF;
    font-style: italic;
    letter-spacing: 1px;
    text-shadow: 2px 2px 0px #D500F9; /* Pop art shadow */
    line-height: 1;
  }
  
  .nsn-powered {
      font-size: 8px;
      color: #00E5FF;
      font-weight: 700;
      text-transform: uppercase;
      margin-top: 4px;
      letter-spacing: 0.5px;
  }

  /* The Scrolling Area (Viewport) */
  .scroll-area {
    flex: 1;
    height: 100%;
    overflow: hidden;
    position: relative;
    /* Soft mask for entry/exit */
    mask-image: linear-gradient(to right, 
      transparent 0%, 
      black 2%, 
      black 98%, 
      transparent 100%
    );
  }

  /* The Content Track that moves */
  .scroll-track {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    display: flex; 
    align-items: center;
    white-space: nowrap;
    font-size: 24px; /* Larger text for mobile readability */
    font-weight: 700;
    color: #FFFFFF;
    padding-left: 20px; 
    transition: transform 0s linear; 
    letter-spacing: -0.2px; 
  }

  /* Individual Ticker Item */
  .item {
    padding-right: 60px; 
    margin-right: 60px; 
    flex-shrink: 0;
    display: flex;
    align-items: center;
  }
  
  /* Game Status/Category Labels */
  .label {
    font-weight: 800;
    margin-right: 14px;
    padding: 4px 10px;
    border-radius: 4px;
    color: #000; /* Black text on bright backgrounds */
    font-size: 16px;
    text-transform: uppercase;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  }

  /* --- SWITCHED UP COLOR PALETTE --- */
  .label-live { 
    background-color: #FF0033; /* Electric Red */
    color: #FFF;
    animation: pulse 2s infinite;
  }
  .label-final { 
    background-color: #FFD700; /* Gold */
    color: #000;
  }
  .label-upcoming { 
    background-color: #00E5FF; /* Cyan */
    color: #000;
  }
  .label-news { 
    background-color: #D500F9; /* Neon Purple */
    color: #FFF;
  }
  .label-chat { 
    background-color: #651FFF; /* Deep Purple/Blue */
    color: #FFF;
  }
  .label-analyst { 
    background-color: #FF4081; /* Hot Pink */
    color: #FFF;
  }
  .label-injury {
    background-color: #FF6D00; /* Safety Orange */
    color: #FFF;
  }
  .label-rumor {
    background-color: #AA00FF; /* Purple Accent */
    color: #FFF;
  }
  
  @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
  }

  /* Mobile/Responsive Adjustments */
  @media (max-width: 600px) {
    .nsn-bar { height: 44px; }
    .nsn-logo { width: 100px; min-width: 100px; }
    .nsn-title { font-size: 18px; }
    .scroll-track { font-size: 18px; }
    .label { font-size: 12px; margin-right: 8px; padding: 2px 6px; }
    .item { padding-right: 30px; margin-right: 30px; }
  }

</style>
</head>

<body>

<div class="nsn-bar">
  <!-- Network Branding -->
  <div class="nsn-logo">
    <div class="nsn-title">NSN LIVE</div>
    <div class="nsn-powered">POWERED BY: NSN NATION</div>
  </div>

  <!-- Ticker Area -->
  <div class="scroll-area">
    <div class="scroll-track" id="track"></div>
  </div>
</div>

<script>
  // ============ GLOBAL STATE & SETTINGS ============
  const SPEED_PX_PER_SEC = 80; 
  const PROXY = "https://corsproxy.io/?"; 
  const REFRESH_INTERVAL_MS = 3 * 60 * 1000; // Refresh all data every 3 minutes

  const track = document.getElementById("track");
  let animationFrameId = null;
  let lastTime = 0;
  let scrollPosition = 0;
  let contentWidth = 0; 

  // Data Sources
  const scoreSources = [
    { label: "NFL", url: "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard" },
    { label: "CFB", url: "https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?limit=25&groups=80" }, 
    { label: "NBA", url: "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard" },
    { label: "CBB", url: "https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard?limit=25&groups=50" }, 
    { label: "NHL", url: "https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard" },
    { label: "MLB", url: "https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard" },
    { label: "EPL", url: "https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/scoreboard" }
  ].map(s => ({ label: s.label, url: PROXY + encodeURIComponent(s.url) }));

  const newsFeeds = [
    { label: "NFL", url: "https://www.espn.com/espn/rss/nfl/news" },
    { label: "NBA", url: "https://www.espn.com/espn/rss/nba/news" },
    { label: "NHL", url: "https://www.espn.com/espn/rss/nhl/news" }
  ].map(f => ({ label: f.label, url: PROXY + encodeURIComponent(f.url) }));
  
  const tiktokEngagementItems = [
    "WELCOME TO NSN LIVE STREAM â€¢ DROP A FOLLOW ON TIKTOK!",
    "ðŸš¨ SONG REQUESTS ARE ON! TYPE '!play Song - Artist' IN CHAT ðŸŽ¶",
    "ðŸ”¥ JOIN THE CLUB FOR 1 COIN! BECOME A MEMBER OF NSN NATION TODAY! ðŸ”¥",
    "POLL: WHO IS THE MOST OVERRATED TEAM? COMMENT BELOW!",
    "BREAKING NEWS: CHECK OUR TIKTOK PAGE FOR UPDATES",
    "TRIVIA: ANSWER IN CHAT FOR A SHOUTOUT!",
  ];

  const analystHotTakes = [
    "ANALYST HOT TAKE: LEBRON JAMES IS *NOT* A TOP 5 PLAYER ALL-TIME!",
    "FIRST TAKE: PATRICK MAHOMES IS THE ONLY GENERATIONAL QB RIGHT NOW.",
    "SKIP BAYLESS: COWBOYS ARE SUPER BOWL BOUND. PERIOD.",
    "NBA HOT TAKE: TATUM NEEDS A 'KILLER INSTINCT' TO WIN A RING.",
    "NFL DEBATE: JALEN HURTS > JOE BURROW. FACTS OVER FEELINGS.",
    "NHL SHOCKER: OILERS WINNING THE CUP THIS YEAR.",
  ];

  // Helper function to randomize arrays
  function shuffle(a) {
    return a.map(v => [Math.random(), v]).sort((x, y) => x[0] - y[0]).map(p => p[1]);
  }

  async function fetchData(url, retries = 3) {
    for (let i = 0; i < retries; i++) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return await res.json();
      } catch (e) {
        if (i < retries - 1) {
             await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
        }
      }
    }
    return { events: [] }; 
  }

  async function fetchTextData(url, retries = 3) {
    for (let i = 0; i < retries; i++) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return await res.text();
      } catch (e) {
        if (i < retries - 1) {
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
        }
      }
    }
    return "";
  }

  // --- DATE FORMATTING LOGIC ---
  function formatGameTime(dateStr) {
    try {
      const d = new Date(dateStr);
      const now = new Date();
      
      // Check if it's today
      const isToday = d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      
      const timeString = d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" });
      
      if (isToday) {
          return timeString; // Just show time for today
      } else {
          // Show "Mon 11/18 7:30 PM" for future games
          const day = d.toLocaleDateString("en-US", { weekday: 'short' });
          const date = d.toLocaleDateString("en-US", { month: 'numeric', day: 'numeric' });
          return `${day} ${date} ${timeString}`;
      }
    } catch {
      return "TBD";
    }
  }

  function getTeamName(teamObj) {
      let name = teamObj.team?.abbreviation || "TEAM";
      if (teamObj.curatedRank && teamObj.curatedRank.current <= 25) {
          name = `(#${teamObj.curatedRank.current}) ${name}`;
      }
      return name;
  }
  
  // ==========================================================
  // CONTENT GENERATORS
  // ==========================================================

  function getChatAndAnalystItems() {
    const items = [];
    const combinedEngagement = [...tiktokEngagementItems, ...analystHotTakes];

    combinedEngagement.forEach(t => { 
        let label = "TIKTOK CHAT"; 
        let text = t;
        let labelClass = "label-chat";

        if (t.includes("ANALYST") || t.includes("BAYLESS") || t.includes("FIRST TAKE") || t.includes("SHOCKER")) {
            label = "HOT TAKE";
            labelClass = "label-analyst";
        } else if (t.includes("SONG REQUESTS") || t.includes("1 COIN")) {
            label = "NSN ALERT";
            labelClass = "label-live"; // Use bright red for important alerts
        } else if (t.includes("POLL") || t.includes("TRIVIA")) {
            label = "INTERACT";
            labelClass = "label-upcoming";
        }

        items.push({ label, text, labelClass });
    });
    return items;
  }

  async function getScoreItems() {
    const items = [];

    for (const src of scoreSources) {
      try {
        const data = await fetchData(src.url);
        const events = (data && data.events) ? data.events : [];
        
        const gamesToAdd = events.filter(ev => ev.status?.type?.state?.toLowerCase() !== 'postponed');

        let added = 0;
        for (const ev of gamesToAdd.slice(0, 15)) { 
          if (added >= 15) { break; }
          
          const comp = ev.competitions?.[0];
          if (!comp || comp.competitors.length < 2) { continue; }

          const status = ev.status?.type || {};
          const desc = (status.description || "").toLowerCase();
          const state = (status.state || "").toLowerCase();
          const short = status.shortDetail || "";
          const isFinal = status.completed || desc.includes("final");
          const isLive = state.includes("in") || desc.includes("live");

          const homeTeam = comp.competitors.find(c => c.homeAway === 'home') || comp.competitors[0];
          const awayTeam = comp.competitors.find(c => c.homeAway === 'away') || comp.competitors[1];
          
          const t1 = getTeamName(awayTeam);
          const t2 = getTeamName(homeTeam);

          let label, labelClass, text;

          if (isFinal) {
            label = `${src.label} FINAL`;
            labelClass = "label-final";
            text = `${t1} ${awayTeam.score} @ ${t2} ${homeTeam.score}` + (short ? ` | ${short}` : "");
          } else if (isLive) {
            label = `${src.label} LIVE`;
            labelClass = "label-live";
            text = `${t1} ${awayTeam.score} @ ${t2} ${homeTeam.score}` + (short ? ` | ${short}` : "");
          } else {
            label = `${src.label}`;
            labelClass = "label-upcoming";
            // Use the new Date/Time format function here
            const timeText = formatGameTime(ev.date); 
            text = `${t1} @ ${t2}` + (timeText ? ` | ${timeText}` : " | TBD");
          }

          items.push({ label, text, labelClass });
          added++;
        }
      } catch (e) {
        console.error("Score block failed for", src.label, e);
      }
    }
    return items;
  }

  async function getNewsItems() {
    const items = [];
    const parser = new DOMParser();

    // Keywords for detecting Injuries
    const injuryKeywords = ["injury", "out", "surgery", "IR", "questionable", "doubtful", "sidelined", "fracture", "tear", "sprain"];
    // Keywords for detecting Rumors
    const rumorKeywords = ["rumor", "trade", "source", "report", "linked to", "talks", "interest", "shopping", "extension", "deal"];

    for (const feed of newsFeeds) {
      try {
        const text = await fetchTextData(feed.url);
        if (!text) { continue; }
        const xml = parser.parseFromString(text, "text/xml");
        const newsItems = Array.from(xml.querySelectorAll("item")).slice(0, 4); // Check slightly more items to find injuries

        for (const item of newsItems) {
          const titleNode = item.querySelector("title");
          if (!titleNode || !titleNode.textContent) { continue; }
          
          let title = titleNode.textContent.trim();
          title = title.replace(/^\[.+?\]\s?/, ''); 

          const lowerTitle = title.toLowerCase();
          let label = feed.label + " NEWS";
          let labelClass = "label-news";

          // Check for Injuries first (High Priority)
          if (injuryKeywords.some(keyword => lowerTitle.includes(keyword))) {
              label = "INJURY UPDATE";
              labelClass = "label-injury";
          } 
          // Check for Rumors
          else if (rumorKeywords.some(keyword => lowerTitle.includes(keyword))) {
              label = "RUMOR MILL";
              labelClass = "label-rumor";
          }

          items.push({ label: label, text: title.toUpperCase(), labelClass: labelClass });
        }
      } catch (e) {
        console.error("News block failed for", feed.label, e);
      }
    }
    return items;
  }

  // Function to create and append a single item to the track DOM element
  function addItemToDOM({ label, text, labelClass }) {
    const span = document.createElement("span");
    span.className = "item";
    const cls = labelClass ? `label ${labelClass}` : "label";
    span.innerHTML = `<span class="${cls}">${label}</span>${text}`;
    track.appendChild(span);
  }

  // ==========================================================
  // MAIN BUILDER
  // ==========================================================
  async function buildTicker() {
    const [chatAndAnalyst, scores, news] = await Promise.all([
      getChatAndAnalystItems(),
      getScoreItems(),
      getNewsItems()
    ]);

    let allItems = [...chatAndAnalyst, ...scores, ...news];
    if (allItems.length === 0) {
        allItems.push({ 
            label: "SYSTEM", 
            text: "DATA FEED UNAVAILABLE. TUNE INTO TIKTOK FOR LIVE UPDATES.", 
            labelClass: "label-final" 
        });
    }

    allItems = shuffle(allItems);
    
    track.innerHTML = "";
    allItems.forEach(item => addItemToDOM(item));

    track.style.transform = 'translateX(0px)'; 
    contentWidth = track.scrollWidth; 
    
    const originalContent = track.innerHTML;
    track.innerHTML += originalContent;

    startAnimation();
  }

  function animate(currentTime) {
    if (!lastTime) lastTime = currentTime;
    const deltaTime = currentTime - lastTime;
    lastTime = currentTime;
    const distanceToMove = (SPEED_PX_PER_SEC / 1000) * deltaTime;
    scrollPosition += distanceToMove;

    if (contentWidth > 0 && scrollPosition >= contentWidth) {
      scrollPosition -= contentWidth;
    }

    track.style.transform = `translateX(-${scrollPosition}px)`;
    animationFrameId = requestAnimationFrame(animate);
  }

  function startAnimation() {
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    lastTime = 0; 
    scrollPosition = 0; 
    animationFrameId = requestAnimationFrame(animate);
  }

  document.addEventListener("DOMContentLoaded", buildTicker);
  setInterval(buildTicker, REFRESH_INTERVAL_MS); 
</script>

</body>
</html>
